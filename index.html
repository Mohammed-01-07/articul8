import React, { useState, useEffect, useRef } from 'react';
import { LineChart, Line, XAxis, YAxis, Tooltip, ResponsiveContainer, PieChart, Pie, Cell, Legend } from 'recharts';

const TRANSLATIONS = {
  en: {
    appTitle: 'ğŸŒ¿ Articul8 EcoSense', healthLabel: 'HEARING HEALTH SCORE', healthStatus: 'Excellent Condition',
    healthExposure: "Today's exposure: {0} minutes above 85 dB", achievementsTitle: 'ğŸ† Achievements',
    challengesTitle: 'ğŸ¯ Daily Challenges', statsTitle: 'ğŸ“Š Your Statistics', sleepTitle: 'Sleep Quality Tracker',
    sleepDesc: 'Monitor noise disruptions during sleep', sleepBtnText: 'Start Sleep Monitoring',
    stopSleepBtnText: 'Stop Sleep Monitoring', recordTitle: 'ğŸ¤ Environmental Recording', recordStatus: 'Tap to record',
    recordingStatus: 'Recording...', filterAll: 'All', filterToday: 'Today', filterWeek: 'This Week',
    filterMonth: 'This Month', analyticsDistTitle: 'ğŸ“ˆ Sound Distribution', analyticsTrendTitle: 'ğŸ“‰ Noise Trends',
    analyticsHealthTitle: 'ğŸ¥ Health Standards', exportCSV: 'Export Data (CSV)', exportReport: 'Generate Report',
    clearAll: 'Clear All Data', communityMapTitle: 'ğŸŒ Community Noise Map', communityNearbyTitle: 'ğŸ“ Nearby Recordings',
    navHome: 'Home', navRecord: 'Record', navData: 'Data', navAnalytics: 'Analytics', navCommunity: 'Community',
    navProfile: 'Profile', deleteBtn: 'ğŸ—‘ï¸ Delete', compareBtn: 'âš–ï¸ Compare', selectedText: 'âœ“ Selected',
    totalRecordings: 'Total Recordings', avgNoiseLevel: 'Avg Noise Level', achievementsUnlocked: 'Achievements Unlocked',
    hearingHealth: 'Hearing Health', locationPlaceholder: 'ğŸ“ Location name', profileLevelText: 'Level',
    profileExplorerText: 'Explorer', profileDayText: 'Day Streak', noDataYet: 'No Data Yet',
    noDataDesc: 'Record some data to see analytics!', noRecordings: 'No recordings found', category: 'Category',
    temp: 'Temp', humidity: 'Humidity', total: 'Total', recordings: 'Recordings', streak: 'Streak', days: 'Days',
    comparison: 'ğŸ“Š Location Comparison', vs: 'vs', noiseLevel: 'Noise Level', temperature: 'Temperature',
    analysis: 'Analysis', louder: 'louder', quieter: 'quieter', than: 'than', close: 'Close',
    selectLanguage: 'Select Language', whoSafeLimit: 'WHO Safe Limit', daytime: 'Daytime', yourAverage: 'Your Average',
    current: 'Current', damageRisk: 'Damage Risk', threshold: 'Threshold', profileSettingsTitle: 'âš™ï¸ Settings',
    profileChangeLang: 'Change Language', profileShareApp: 'Share App', profileAboutTitle: 'â„¹ï¸ About'
  },
  ar: {
    appTitle: 'ğŸŒ¿ Articul8 EcoSense', healthLabel: 'Ø¯Ø±Ø¬Ø© ØµØ­Ø© Ø§Ù„Ø³Ù…Ø¹', healthStatus: 'Ø­Ø§Ù„Ø© Ù…Ù…ØªØ§Ø²Ø©',
    healthExposure: 'Ø§Ù„ØªØ¹Ø±Ø¶ Ø§Ù„ÙŠÙˆÙ…: {0} Ø¯Ù‚ÙŠÙ‚Ø© ÙÙˆÙ‚ 85 Ø¯ÙŠØ³ÙŠØ¨Ù„', achievementsTitle: 'ğŸ† Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª',
    challengesTitle: 'ğŸ¯ Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©', statsTitle: 'ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙƒ', sleepTitle: 'Ù…ØªØªØ¨Ø¹ Ø¬ÙˆØ¯Ø© Ø§Ù„Ù†ÙˆÙ…',
    sleepDesc: 'Ø±Ø§Ù‚Ø¨ Ø§Ø¶Ø·Ø±Ø§Ø¨Ø§Øª Ø§Ù„Ø¶ÙˆØ¶Ø§Ø¡ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…', sleepBtnText: 'Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù†ÙˆÙ…',
    stopSleepBtnText: 'Ø¥ÙŠÙ‚Ø§Ù Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù†ÙˆÙ…', recordTitle: 'ğŸ¤ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ¦ÙŠ', recordStatus: 'Ø§Ù†Ù‚Ø± Ù„Ù„ØªØ³Ø¬ÙŠÙ„',
    recordingStatus: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...', filterAll: 'Ø§Ù„ÙƒÙ„', filterToday: 'Ø§Ù„ÙŠÙˆÙ…', filterWeek: 'Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹',
    filterMonth: 'Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±', navHome: 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', navRecord: 'ØªØ³Ø¬ÙŠÙ„', navData: 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
    navAnalytics: 'Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª', navCommunity: 'Ø§Ù„Ù…Ø¬ØªÙ…Ø¹', navProfile: 'Ø§Ù„Ù…Ù„Ù', deleteBtn: 'ğŸ—‘ï¸ Ø­Ø°Ù',
    compareBtn: 'âš–ï¸ Ù…Ù‚Ø§Ø±Ù†Ø©', selectedText: 'âœ“ Ù…Ø­Ø¯Ø¯', locationPlaceholder: 'ğŸ“ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹',
    noRecordings: 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªØ³Ø¬ÙŠÙ„Ø§Øª', category: 'Ø§Ù„ÙØ¦Ø©', temp: 'Ø§Ù„Ø­Ø±Ø§Ø±Ø©', humidity: 'Ø§Ù„Ø±Ø·ÙˆØ¨Ø©',
    close: 'Ø¥ØºÙ„Ø§Ù‚', selectLanguage: 'Ø§Ø®ØªØ± Ø§Ù„Ù„ØºØ©'
  },
  es: {
    appTitle: 'ğŸŒ¿ Articul8 EcoSense', healthLabel: 'PUNTUACIÃ“N DE SALUD AUDITIVA', healthStatus: 'Excelente CondiciÃ³n',
    achievementsTitle: 'ğŸ† Logros', challengesTitle: 'ğŸ¯ DesafÃ­os Diarios', recordTitle: 'ğŸ¤ GrabaciÃ³n Ambiental',
    recordStatus: 'Toca para grabar', recordingStatus: 'Grabando...', filterAll: 'Todo', filterToday: 'Hoy',
    navHome: 'Inicio', navRecord: 'Grabar', navData: 'Datos', navAnalytics: 'AnÃ¡lisis', navCommunity: 'Comunidad',
    navProfile: 'Perfil', deleteBtn: 'ğŸ—‘ï¸ Eliminar', compareBtn: 'âš–ï¸ Comparar', close: 'Cerrar', selectLanguage: 'Seleccionar Idioma'
  },
  fr: {
    appTitle: 'ğŸŒ¿ Articul8 EcoSense', healthLabel: 'SCORE DE SANTÃ‰ AUDITIVE', healthStatus: 'Excellente Condition',
    achievementsTitle: 'ğŸ† RÃ©alisations', recordTitle: 'ğŸ¤ Enregistrement', recordStatus: 'Appuyez pour enregistrer',
    filterAll: 'Tout', navHome: 'Accueil', navRecord: 'Enregistrer', navData: 'DonnÃ©es', navProfile: 'Profil',
    deleteBtn: 'ğŸ—‘ï¸ Supprimer', close: 'Fermer', selectLanguage: 'Choisir la Langue'
  },
  de: {
    appTitle: 'ğŸŒ¿ Articul8 EcoSense', healthLabel: 'GEHÃ–RGESUNDHEITS-SCORE', healthStatus: 'Ausgezeichnet',
    achievementsTitle: 'ğŸ† Erfolge', recordTitle: 'ğŸ¤ Aufzeichnung', recordStatus: 'Tippen zum Aufnehmen',
    filterAll: 'Alle', navHome: 'Startseite', navRecord: 'Aufnehmen', navData: 'Daten', navProfile: 'Profil',
    deleteBtn: 'ğŸ—‘ï¸ LÃ¶schen', close: 'SchlieÃŸen', selectLanguage: 'Sprache WÃ¤hlen'
  }
};

const COLORS = ['#ef4444', '#f97316', '#3b82f6', '#10b981', '#6b7280'];

export default function EcoSenseApp() {
  const [tab, setTab] = useState('home');
  const [dark, setDark] = useState(false);
  const [lang, setLang] = useState('en');
  const [xp, setXp] = useState(0);
  const [level, setLevel] = useState(1);
  const [streak, setStreak] = useState(0);
  const [recs, setRecs] = useState([]);
  const [achievements, setAchievements] = useState({ firstRecord: false, tenRecords: false, quietSeeker: false, noiseFinder: false, weekStreak: false, allCategories: false });
  const [challenges, setChallenges] = useState({ record3: { done: false, progress: 0, target: 3 }, findQuiet: { done: false, progress: 0, target: 1 }, findLoud: { done: false, progress: 0, target: 1 } });
  const [health, setHealth] = useState({ score: 100, exposure: 0 });
  const [recording, setRecording] = useState(false);
  const [db, setDb] = useState(0);
  const [loc, setLoc] = useState('');
  const [filter, setFilter] = useState('all');
  const [compare, setCompare] = useState([]);
  const [showLang, setShowLang] = useState(false);
  const [showComp, setShowComp] = useState(false);
  const [notif, setNotif] = useState('');
  const [sleep, setSleep] = useState(false);
  const streamRef = useRef(null);
  const ctxRef = useRef(null);
  const analyserRef = useRef(null);

  const t = { ...TRANSLATIONS.en, ...TRANSLATIONS[lang] };

  useEffect(() => { if (notif) { const tm = setTimeout(() => setNotif(''), 3000); return () => clearTimeout(tm); } }, [notif]);
  useEffect(() => { if (compare.length === 2) setShowComp(true); }, [compare]);
  useEffect(() => { return () => { if (streamRef.current) streamRef.current.getTracks().forEach(t => t.stop()); }; }, []);

  const notify = (msg) => setNotif(msg);
  const addXP = (amt) => {
    const nx = xp + amt;
    const need = level * 100;
    if (nx >= need) { setLevel(level + 1); setXp(nx - need); notify('ğŸ‰ Level Up!'); }
    else setXp(nx);
  };

  const startRec = async () => {
    if (recording) return;
    try {
      setRecording(true);
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      streamRef.current = stream;
      ctxRef.current = new (window.AudioContext || window.webkitAudioContext)();
      analyserRef.current = ctxRef.current.createAnalyser();
      ctxRef.current.createMediaStreamSource(stream).connect(analyserRef.current);
      analyserRef.current.fftSize = 256;
      const arr = new Uint8Array(analyserRef.current.frequencyBinCount);
      let max = 0;
      const update = () => {
        if (!recording) return;
        analyserRef.current.getByteFrequencyData(arr);
        const avg = arr.reduce((a, b) => a + b) / arr.length;
        const d = Math.round(Math.min(100, Math.max(30, (avg / 255) * 70 + 30)));
        max = Math.max(max, d);
        setDb(d);
        requestAnimationFrame(update);
      };
      update();
      setTimeout(() => stopRec(max), 5000);
    } catch (e) {
      setRecording(false);
      notify('âŒ Microphone access denied');
    }
  };

  const stopRec = (max) => {
    if (streamRef.current) streamRef.current.getTracks().forEach(t => t.stop());
    setRecording(false);
    setDb(0);
    const cats = ['traffic', 'construction', 'people', 'nature', 'silence'];
    const cat = cats[Math.floor(Math.random() * cats.length)];
    const rec = { id: Date.now(), ts: Date.now(), date: new Date().toLocaleDateString(), time: new Date().toLocaleTimeString(), loc: loc || 'Unnamed', cat, db: max, temp: 20 + Math.floor(Math.random() * 15), hum: 40 + Math.floor(Math.random() * 40) };
    setRecs([rec, ...recs]);
    setLoc('');
    addXP(10);
    setStreak(s => s + 1);
    if (!achievements.firstRecord) { setAchievements({ ...achievements, firstRecord: true }); addXP(50); notify('ğŸ† First Recording!'); }
    setChallenges(c => {
      const u = { ...c };
      if (!u.record3.done) { u.record3.progress++; if (u.record3.progress >= 3) { u.record3.done = true; addXP(50); } }
      if (!u.findQuiet.done && max < 45) { u.findQuiet.progress = 1; u.findQuiet.done = true; addXP(30); }
      if (!u.findLoud.done && max > 75) { u.findLoud.progress = 1; u.findLoud.done = true; addXP(30); }
      return u;
    });
    if (max >= 85) setHealth(h => ({ ...h, exposure: h.exposure + 5, score: Math.max(20, h.score - 5) }));
    notify(`âœ… Recorded: ${max} dB - ${cat}`);
  };

  const getColor = (d) => d < 40 ? '#10b981' : d < 55 ? '#84cc16' : d < 70 ? '#f59e0b' : d < 85 ? '#f97316' : '#ef4444';
  const filtered = () => {
    const now = Date.now(), day = 86400000;
    if (filter === 'today') return recs.filter(r => now - r.ts < day);
    if (filter === 'week') return recs.filter(r => now - r.ts < 7 * day);
    if (filter === 'month') return recs.filter(r => now - r.ts < 30 * day);
    return recs;
  };
  const catCounts = recs.reduce((a, r) => { a[r.cat] = (a[r.cat] || 0) + 1; return a; }, {});
  const chartData = Object.entries(catCounts).map(([n, v]) => ({ name: n, value: v }));
  const trendData = [...recs].reverse().slice(0, 10).map((r, i) => ({ name: `#${i + 1}`, db: r.db }));
  const compRecs = compare.map(id => recs.find(r => r.id === id)).filter(Boolean);
  const xpProg = (xp / (level * 100)) * 100;

  const achList = [{ id: 'firstRecord', icon: 'ğŸ¤', name: 'First Steps' }, { id: 'tenRecords', icon: 'ğŸ“Š', name: 'Collector' }, { id: 'quietSeeker', icon: 'ğŸ¤«', name: 'Quiet Seeker' }, { id: 'noiseFinder', icon: 'ğŸ“¢', name: 'Noise Finder' }, { id: 'weekStreak', icon: 'ğŸ”¥', name: 'Week Warrior' }, { id: 'allCategories', icon: 'ğŸŒŸ', name: 'Master' }];
  const chalList = [{ id: 'record3', title: 'Record 3 Times', desc: '3 recordings today' }, { id: 'findQuiet', title: 'Find Peace', desc: 'Under 45 dB' }, { id: 'findLoud', title: 'Find Noise', desc: 'Above 75 dB' }];

  return (
    <div className={`min-h-screen ${dark ? 'bg-gray-900' : 'bg-gradient-to-br from-purple-600 to-purple-800'} pb-20`}>
      <div className="bg-black bg-opacity-30 p-4 sticky top-0 z-50">
        <div className="flex justify-between items-center max-w-2xl mx-auto">
          <div className="flex items-center gap-3">
            <button onClick={() => setDark(!dark)} className="w-10 h-10 rounded-full bg-white bg-opacity-20 flex items-center justify-center text-xl">{dark ? 'â˜€ï¸' : 'ğŸŒ™'}</button>
            <button onClick={() => setShowLang(true)} className="w-10 h-10 rounded-full bg-white bg-opacity-20 flex items-center justify-center text-xl">ğŸŒ</button>
            <h1 className="text-xl font-bold text-white">{t.appTitle}</h1>
          </div>
          <div className="text-right text-sm text-white">
            <div className="font-bold">Lvl {level} â€¢ {xp} XP</div>
            <div className="w-32 h-1 bg-white bg-opacity-20 rounded mt-1"><div className="h-full bg-yellow-400 rounded" style={{ width: `${xpProg}%` }} /></div>
          </div>
        </div>
      </div>

      {notif && <div className="fixed top-20 left-4 right-4 bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-4 rounded-2xl shadow-xl z-50">{notif}</div>}

      {showLang && (
        <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4" onClick={() => setShowLang(false)}>
          <div className={`${dark ? 'bg-gray-800' : 'bg-white'} rounded-2xl p-6 max-w-md w-full`} onClick={e => e.stopPropagation()}>
            <h2 className={`text-xl font-bold mb-4 ${dark ? 'text-white' : 'text-gray-900'}`}>{t.selectLanguage}</h2>
            <div className="flex flex-wrap gap-2 mb-4">
              {[{ c: 'en', l: 'ğŸ‡¬ğŸ‡§ English' }, { c: 'ar', l: 'ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' }, { c: 'es', l: 'ğŸ‡ªğŸ‡¸ EspaÃ±ol' }, { c: 'fr', l: 'ğŸ‡«ğŸ‡· FranÃ§ais' }, { c: 'de', l: 'ğŸ‡©ğŸ‡ª Deutsch' }].map(x => (
                <button key={x.c} onClick={() => { setLang(x.c); setShowLang(false); }} className={`px-4 py-2 rounded-full font-semibold ${lang === x.c ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-800'}`}>{x.l}</button>
              ))}
            </div>
            <button onClick={() => setShowLang(false)} className="w-full bg-green-500 text-white py-3 rounded-xl font-bold">{t.close}</button>
          </div>
        </div>
      )}

      {showComp && compRecs.length === 2 && (
        <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4" onClick={() => { setShowComp(false); setCompare([]); }}>
          <div className={`${dark ? 'bg-gray-800' : 'bg-white'} rounded-2xl p-6 max-w-md w-full`} onClick={e => e.stopPropagation()}>
            <h2 className={`text-xl font-bold mb-4 ${dark ? 'text-white' : 'text-gray-900'}`}>{t.comparison}</h2>
            <div className="text-center mb-4">
              <div className={`font-bold ${dark ? 'text-white' : 'text-gray-900'}`}>{compRecs[0].loc}</div>
              <div className="text-sm text-gray-500">{t.vs}</div>
              <div className={`font-bold ${dark ? 'text-white' : 'text-gray-900'}`}>{compRecs[1].loc}</div>
            </div>
            <div className="grid grid-cols-2 gap-3 mb-4">
              <div className="text-center p-3 bg-purple-100 rounded-xl"><div className="text-xs text-gray-600">{t.noiseLevel}</div><div className="text-2xl font-bold" style={{ color: getColor(compRecs[0].db) }}>{compRecs[0].db} dB</div></div>
              <div className="text-center p-3 bg-purple-100 rounded-xl"><div className="text-xs text-gray-600">{t.noiseLevel}</div><div className="text-2xl font-bold" style={{ color: getColor(compRecs[1].db) }}>{compRecs[1].db} dB</div></div>
            </div>
            <div className="bg-green-100 p-3 rounded-xl mb-4"><div className="font-bold text-gray-900">{t.analysis}</div><div className="text-sm text-gray-700">{compRecs[0].loc} is {Math.abs(compRecs[0].db - compRecs[1].db)} dB {compRecs[0].db > compRecs[1].db ? t.louder : t.quieter} {t.than} {compRecs[1].loc}.</div></div>
            <button onClick={() => { setShowComp(false); setCompare([]); }} className="w-full bg-green-500 text-white py-3 rounded-xl font-bold">{t.close}</button>
          </div>
        </div>
      )}

      <div className="max-w-2xl mx-auto p-4">
        {tab === 'home' && (
          <div>
            <div className="bg-gradient-to-br from-green-500 to-green-600 rounded-3xl p-6 mb-4 text-white shadow-xl">
              <div className="text-center text-sm opacity-90">{t.healthLabel}</div>
              <div className="text-6xl font-bold text-center my-4">{health.score}</div>
              <div className="text-center text-sm opacity-90">{t.healthStatus}</div>
              <div className="w-full h-3 bg-white bg-opacity-30 rounded-full mt-4"><div className="h-full bg-white rounded-full" style={{ width: `${health.score}%` }} /></div>
              <div className="text-center text-sm mt-4 opacity-90">{t.healthExposure.replace('{0}', Math.round(health.exposure / 60))}</div>
            </div>
            <div className={`${dark ? 'bg-gray-800' : 'bg-white'} rounded-3xl p-6 mb-4 shadow-xl`}>
              <h2 className={`text-xl font-bold mb-4 ${dark ? 'text-white' : 'text-gray-900'}`}>{t.achievementsTitle}</h2>
              <div className="grid grid-cols-3 gap-3">
                {achList.map(a => (<div key={a.id} className={`p-4 rounded-2xl text-center ${achievements[a.id] ? 'bg-yellow-100 border-2 border-yellow-400' : 'bg-gray-100 opacity-50'}`}><div className="text-3xl mb-2">{a.icon}</div><div className="text-xs font-semibold text-gray-900">{a.name}</div></div>))}
              </div>
            </div>
            <div className={`${dark ? 'bg-gray-800' : 'bg-white'} rounded-3xl p-6 mb-4 shadow-xl`}>
              <h2 className={`text-xl font-bold mb-4 ${dark ? 'text-white' : 'text-gray-900'}`}>{t.challengesTitle}</h2>
              {chalList.map(c => { const ch = challenges[c.id]; return (<div key={c.id} className="bg-purple-50 p-4 rounded-2xl mb-3"><div className="font-bold text-gray-900">{ch.done ? 'âœ…' : 'â­•'} {c.title}</div><div className="text-sm text-gray-600 mb-2">{c.desc}</div><div className="flex items-center gap-3"><div className="flex-1 h-2 bg-gray-200 rounded-full"><div className="h-full bg-purple-600 rounded-full" style={{ width: `${(ch.progress / ch.target) * 100}%` }} /></div><div className="text-sm font-bold text-gray-900">{ch.progress}/{ch.target}</div></div></div>); })}
            </div>
            {recs.length > 0 && (<div className={`${dark ? 'bg-gray-800' : 'bg-white'} rounded-3xl p-6 shadow-xl`}><h2 className={`text-xl font-bold mb-4 ${dark ? 'text-white' : 'text-gray-900'}`}>{t.statsTitle}</h2><div className="grid grid-cols-2 gap-4"><div className="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-2xl text-center text-white"><div className="text-sm opacity-90">{t.total}</div><div className="text-4xl font-bold my-2">{recs.length}</div><div className="text-sm opacity-90">{t.recordings}</div></div><div className="bg-gradient-to-br from-orange-500 to-orange-600 p-6 rounded-2xl text-center text-white"><div className="text-sm opacity-90">{t.streak}</div><div className="text-4xl font-bold my-2">{streak} ğŸ”¥</div><div className="text-sm opacity-90">{t.days}</div></div></div></div>)}
          </div>
        )}

        {tab === 'record' && (
          <div>
            <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-3xl p-6 mb-4 text-white shadow-xl">
              <div className="text-center"><div className="text-5xl mb-3">ğŸ˜´</div><div className="text-xl font-bold mb-2">{t.sleepTitle}</div><div className="text-sm opacity-90 mb-4">{t.sleepDesc}</div><button onClick={() => { setSleep(!sleep); notify(sleep ? 'â° Sleep ended' : 'ğŸ˜´ Sleep mode on!'); }} className="w-full bg-white text-blue-600 py-3 rounded-2xl font-bold">ğŸŒ™ {sleep ? t.stopSleepBtnText : t.sleepBtnText}</button></div>
            </div>
            <div className={`${dark ? 'bg-gray-800' : 'bg-white'} rounded-3xl p-6 shadow-xl`}>
              <h2 className={`text-xl font-bold mb-4 ${dark ? 'text-white' : 'text-gray-900'}`}>{t.recordTitle}</h2>
              <input type="text" value={loc} onChange={e => setLoc(e.target.value)} placeholder={t.locationPlaceholder} className={`w-full p-4 border-2 rounded-2xl mb-4 ${dark ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-200 text-gray-900'}`} />
              <button onClick={startRec} disabled={recording} className={`w-40 h-40 rounded-full mx-auto flex items-center justify-center text-6xl ${recording ? 'bg-red-500 animate-pulse' : 'bg-green-500 hover:scale-105'} text-white mb-4 transition-all shadow-2xl`}>{recording ? 'â¹ï¸' : 'ğŸ¤'}</button>
              <div className="text-center"><div className={`text-5xl font-bold mb-2 ${dark ? 'text-green-400' : 'text-green-500'}`}>{db} dB</div><div className={`text-sm ${dark ? 'text-gray-400' : 'text-gray-600'}`}>{recording ? t.recordingStatus : t.recordStatus}</div></div>
            </div>
          </div>
        )}

        {tab === 'data' && (
          <div>
            <div className="flex gap-2 mb-4 overflow-x-auto pb-2">
              {['all', 'today', 'week', 'month'].map(f => (<button key={f} onClick={() => setFilter(f)} className={`px-4 py-2 rounded-full font-semibold whitespace-nowrap ${filter === f ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-800'}`}>{t[`filter${f.charAt(0).toUpperCase() + f.slice(1)}`] || f}</button>))}
            </div>
            {filtered().length === 0 ? (<div className={`${dark ? 'bg-gray-800' : 'bg-white'} rounded-3xl p-12 text-center shadow-xl`}><div className={`text-lg ${dark ? 'text-gray-400' : 'text-gray-600'}`}>{t.noRecordings}</div></div>) : (
              filtered().map(r => (<div key={r.id} className={`${dark ? 'bg-gray-800' : 'bg-white'} rounded-3xl p-6 mb-4 shadow-xl ${compare.includes(r.id) ? 'border-4 border-green-500' : ''}`}><div className="flex justify-between items-start mb-4"><div><div className={`font-bold text-lg ${dark ? 'text-white' : 'text-gray-900'}`}>{r.loc}</div><div className={`text-sm ${dark ? 'text-gray-400' : 'text-gray-600'}`}>ğŸ“… {r.date} â€¢ â° {r.time}</div></div><div className="px-4 py-2 rounded-full text-white font-bold" style={{ backgroundColor: getColor(r.db) }}>{r.db} dB</div></div><div className="grid grid-cols-3 gap-2 mb-4"><div className="text-center p-3 bg-purple-100 rounded-xl"><div className="text-xs text-gray-600">{t.category}</div><div className="font-bold text-gray-900">{r.cat}</div></div><div className="text-center p-3 bg-orange-100 rounded-xl"><div className="text-xs text-gray-600">{t.temp}</div><div className="font-bold text-gray-900">{r.temp}Â°C</div></div><div className="text-center p-3 bg-blue-100 rounded-xl"><div className="text-xs text-gray-600">{t.humidity}</div><div className="font-bold text-gray-900">{r.hum}%</div></div></div><div className="flex gap-2"><button onClick={() => { if (compare.includes(r.id)) setCompare(compare.filter(i => i !== r.id)); else if (compare.length < 2) setCompare([...compare, r.id]); else notify('Max 2'); }} className="flex-1 bg-orange-500 text-white py-3 rounded-xl font-semibold">{compare.includes(r.id) ? t.selectedText : t.compareBtn}</button><button onClick={() => { if (window.confirm('Delete?')) { setRecs(recs.filter(x => x.id !== r.id)); setCompare(compare.filter(i => i !== r.id)); notify('âœ… Deleted'); } }} className="flex-1 bg-red-500 text-white py-3 rounded-xl font-semibold">{t.deleteBtn}</button></div></div>))
            )}
          </div>
        )}

        {tab === 'analytics' && (
          <div>
            {recs.length === 0 ? (<div className={`${dark ? 'bg-gray-800' : 'bg-white'} rounded-3xl p-12 text-center shadow-xl`}><div className="text-6xl mb-4">ğŸ“Š</div><div className={`text-xl font-bold mb-2 ${dark ? 'text-white' : 'text-gray-900'}`}>{t.noDataYet}</div><div className={`text-sm ${dark ? 'text-gray-400' : 'text-gray-600'}`}>{t.noDataDesc}</div></div>) : (
              <>
                <div className={`${dark ? 'bg-gray-800' : 'bg-white'} rounded-3xl p-6 mb-4 shadow-xl`}><h2 className={`text-xl font-bold mb-4 ${dark ? 'text-white' : 'text-gray-900'}`}>{t.analyticsDistTitle}</h2><ResponsiveContainer width="100%" height={200}><PieChart><Pie data={chartData} dataKey="value" nameKey="name" cx="50%" cy="50%" outerRadius={60} label>{chartData.map((e, i) => (<Cell key={i} fill={COLORS[i % COLORS.length]} />))}</Pie><Legend /><Tooltip /></PieChart></ResponsiveContainer></div>
                <div className={`${dark ? 'bg-gray-800' : 'bg-white'} rounded-3xl p-6 mb-4 shadow-xl`}><h2 className={`text-xl font-bold mb-4 ${dark ? 'text-white' : 'text-gray-900'}`}>{t.analyticsTrendTitle}</h2><ResponsiveContainer width="100%" height={200}><LineChart data={trendData}><XAxis dataKey="name" stroke={dark ? '#9ca3af' : '#6b7280'} /><YAxis stroke={dark ? '#9ca3af' : '#6b7280'} domain={[0, 100]} /><Tooltip /><Line type="monotone" dataKey="db" stroke="#10b981" strokeWidth={3} /></LineChart></ResponsiveContainer></div>
                <div className={`${dark ? 'bg-gray-800' : 'bg-white'} rounded-3xl p-6 mb-4 shadow-xl`}><h2 className={`text-xl font-bold mb-4 ${dark ? 'text-white' : 'text-gray-900'}`}>{t.analyticsHealthTitle}</h2><div className="space-y-3"><div className="flex justify-between p-3 bg-green-100 rounded-xl"><div><div className="font-bold text-green-900">{t.whoSafeLimit}</div><div className="text-xs text-green-700">{t.daytime}</div></div><div className="text-2xl font-bold text-green-900">55 dB</div></div><div className="flex justify-between p-3 bg-blue-100 rounded-xl"><div><div className="font-bold text-blue-900">{t.yourAverage}</div><div className="text-xs text-blue-700">{t.current}</div></div><div className="text-2xl font-bold text-blue-900">{(recs.reduce((s, r) => s + r.db, 0) / recs.length).toFixed(1)} dB</div></div><div className="flex justify-between p-3 bg-red-100 rounded-xl"><div><div className="font-bold text-red-900">{t.damageRisk}</div><div className="text-xs text-red-700">{t.threshold}</div></div><div className="text-2xl font-bold text-red-900">85 dB</div></div></div></div>
                <button onClick={() => { const csv = [['Date', 'Time', 'Location', 'Category', 'dB', 'Temp', 'Humidity'], ...recs.map(r => [r.date, r.time, r.loc, r.cat, r.db, r.temp, r.hum])].map(row => row.join(',')).join('\n'); const b = new Blob([csv], { type: 'text/csv' }); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'ecosense.csv'; a.click(); notify('âœ… Exported!'); }} className="w-full bg-green-500 text-white py-4 rounded-xl font-bold mb-3">ğŸ“¥ {t.exportCSV}</button>
                <button onClick={() => { setRecs([]); setCompare([]); notify('âœ… Cleared'); }} className="w-full bg-red-500 text-white py-4 rounded-xl font-bold">ğŸ—‘ï¸ {t.clearAll}</button>
              </>
            )}
          </div>
        )}

        {tab === 'community' && (
          <div className={`${dark ? 'bg-gray-800' : 'bg-white'} rounded-3xl p-6 shadow-xl`}><h2 className={`text-xl font-bold mb-4 ${dark ? 'text-white' : 'text-gray-900'}`}>{t.communityMapTitle}</h2><div className="text-center py-12"><div className="text-6xl mb-4">ğŸŒ</div><div className={`text-lg font-bold mb-2 ${dark ? 'text-white' : 'text-gray-900'}`}>Community Map</div><div className={`text-sm ${dark ? 'text-gray-400' : 'text-gray-600'}`}>Share your recordings to see them on the map!</div></div></div>
        )}

        {tab === 'profile' && (
          <div>
            <div className={`${dark ? 'bg-gray-800' : 'bg-white'} rounded-3xl p-6 mb-4 shadow-xl`}><div className="text-center py-6"><div className="text-8xl mb-4">ğŸ‘¤</div><div className={`text-3xl font-bold mb-2 ${dark ? 'text-white' : 'text-gray-900'}`}>{t.profileLevelText} {level} {t.profileExplorerText}</div><div className={`text-sm ${dark ? 'text-gray-400' : 'text-gray-600'}`}>{xp} XP â€¢ {streak} ğŸ”¥ {t.profileDayText}</div></div></div>
            <div className={`${dark ? 'bg-gray-800' : 'bg-white'} rounded-3xl p-6 mb-4 shadow-xl`}><h2 className={`text-xl font-bold mb-4 ${dark ? 'text-white' : 'text-gray-900'}`}>{t.statsTitle}</h2><div className="space-y-3"><div className="flex justify-between p-3 bg-purple-100 rounded-xl"><span className="font-semibold text-gray-900">{t.totalRecordings}</span><span className="font-bold text-purple-600">{recs.length}</span></div><div className="flex justify-between p-3 bg-green-100 rounded-xl"><span className="font-semibold text-gray-900">{t.avgNoiseLevel}</span><span className="font-bold text-green-600">{recs.length > 0 ? (recs.reduce((s, r) => s + r.db, 0) / recs.length).toFixed(1) : 0} dB</span></div><div className="flex justify-between p-3 bg-orange-100 rounded-xl"><span className="font-semibold text-gray-900">{t.achievementsUnlocked}</span><span className="font-bold text-orange-600">{Object.values(achievements).filter(a => a).length}/6</span></div><div className="flex justify-between p-3 bg-red-100 rounded-xl"><span className="font-semibold text-gray-900">{t.hearingHealth}</span><span className="font-bold text-red-600">{health.score}</span></div></div></div>
            <div className={`${dark ? 'bg-gray-800' : 'bg-white'} rounded-3xl p-6 shadow-xl`}><h2 className={`text-xl font-bold mb-4 ${dark ? 'text-white' : 'text-gray-900'}`}>{t.profileSettingsTitle}</h2><button onClick={() => setShowLang(true)} className="w-full bg-green-500 text-white py-4 rounded-xl font-bold mb-3">ğŸŒ {t.profileChangeLang}</button><button onClick={() => setDark(!dark)} className="w-full bg-indigo-500 text-white py-4 rounded-xl font-bold mb-3">{dark ? 'â˜€ï¸' : 'ğŸŒ™'} Toggle Dark Mode</button><button onClick={() => notify('ğŸ“‹ Link copied!')} className="w-full bg-pink-500 text-white py-4 rounded-xl font-bold">ğŸ“¤ {t.profileShareApp}</button></div>
          </div>
        )}
      </div>

      <div className={`fixed bottom-0 left-0 right-0 ${dark ? 'bg-gray-800' : 'bg-white'} flex justify-around py-2 shadow-2xl z-50`}>
        {[{ id: 'home', icon: 'ğŸ ', label: t.navHome }, { id: 'record', icon: 'ğŸ¤', label: t.navRecord }, { id: 'data', icon: 'ğŸ“Š', label: t.navData }, { id: 'analytics', icon: 'ğŸ“ˆ', label: t.navAnalytics }, { id: 'community', icon: 'ğŸŒ', label: t.navCommunity }, { id: 'profile', icon: 'ğŸ‘¤', label: t.navProfile }].map(x => (
          <button key={x.id} onClick={() => setTab(x.id)} className={`flex flex-col items-center gap-1 py-2 px-3 ${tab === x.id ? 'text-green-500' : dark ? 'text-gray-400' : 'text-gray-500'}`}><div className="text-2xl">{x.icon}</div><div className="text-xs font-semibold">{x.label}</div></button>
        ))}
      </div>
    </div>
  );
}
